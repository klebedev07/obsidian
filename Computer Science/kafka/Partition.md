В кафка гарантия последовательности поддерживается только на уровен партиций. [[Topic]] не гарантирует последовательности. 

В Apache Kafka используется следующая формула для расчета партиции на основе ключа сообщения:

partition = hash(key) % numPartitions

Где:

- "partition" - номер партиции, в которую будет записано сообщение.
- "hash(key)" - хэш-функция, применяемая к ключу сообщения.
- "numPartitions" - общее количество партиций в теме.

Важно отметить, что при использовании этой формулы необходимо учитывать, что изменение количества партиций в теме может повлиять на распределение данных и порядок обработки сообщений.

выбор хэш-функции не управляется непосредственно Apache Kafka, а зависит от реализации языка Java. Если вам требуется более специфичное или криптографически стойкое хэширование, вы можете использовать собственную хэш-функцию, переопределив метод `hashCode()` для вашего ключевого объекта или использовав сторонние библиотеки для хэширования.

Если ключ партиции не указан явно, Kafka использует механизм раунд-робин для распределения сообщений по доступным партициям. Это означает, что сообщения будут равномерно распределены между партициями без учета содержимого сообщений.

Идеально если число [[consumer]] равно числу партиций. Тогда можно добиться максимальной производительности. Но у такого решения есть недостатки:
- Если мы захотим добавить новы [[consumer]] то мы не сможем этого сделать. Так как свободных партиций нет. Оптимально будет на каждый консумер добавить по 4 партиции.
- Если консумер упадет, то кафка перебалансирует нагрузку и какой то консумер будет находится под большей нагрузкой
Например если у нас 4 [[consumer]] и одна партиция. То работать будет только один consumer.







![[Pasted image 20230611160122.png]] ![[Pasted image 20230611160129.png]]


